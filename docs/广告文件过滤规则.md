# 夸克网盘转存广告文件过滤规则

## 📋 概述

在转存夸克网盘分享链接时，经常会遇到各种广告文件混在真实内容中。这些广告文件通常包括推广图片、文本说明、二维码等，需要在转存前自动过滤掉。

---

## 🎯 广告文件特征分析

### 1. 按文件扩展名分类

#### 图片类广告
- `.jpg` / `.jpeg` - 最常见的广告图片
- `.png` - PNG格式广告图片
- `.gif` - GIF动图广告
- `.bmp` - 位图广告
- `.webp` - WebP格式广告

#### 文本类广告
- `.txt` - 文本说明、推广信息
- `.nfo` - 种子信息文件（常含推广）
- `.url` - 网站链接文件

#### 文档类广告
- `.pdf` - PDF格式推广文档
- `.doc` / `.docx` - Word文档广告
- `.html` / `.htm` - HTML页面广告

### 2. 按文件名关键词分类

#### 推广类关键词（中文）
```
- 关注
- 更新
- 最新
- 订阅
- 公众号
- 微信
- QQ
- 群
- 频道
- 电报
- Telegram
- 推荐
- 福利
- 免费
- 网址
- 网站
- 发布
- 必看
- 说明
- 广告
```

#### 推广类关键词（英文/拼音）
```
- readme
- read me
- notice
- ad
- ads
- adv
- promo
- promotion
- follow
- subscribe
- update
- new
- latest
- channel
```

#### 联系方式类
```
- 二维码
- qrcode
- 微信号
- QQ号
- 电报
- TG
- Discord
```

### 3. 按文件大小分类

广告文件通常较小：
- **图片**: 通常 < 5MB
- **文本**: 通常 < 100KB
- **文档**: 通常 < 10MB

**策略**: 可以设置一个安全阈值，结合扩展名和文件名，对小文件进行更严格的过滤。

### 4. 按文件位置分类

- **根目录**: 广告文件常在分享链接的根目录
- **每个子文件夹**: 每个剧集/电影文件夹里可能都有广告

---

## 🛡️ 过滤规则设计

### 规则1: 扩展名黑名单（严格模式）

**适用场景**: 视频/音频资源转存

```python
AD_EXTENSIONS_STRICT = {
    # 图片
    '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.ico',
    # 文本
    '.txt', '.nfo', '.url',
    # 文档
    '.pdf', '.doc', '.docx', '.html', '.htm', '.xml',
}
```

### 规则2: 文件名关键词黑名单

**适用场景**: 所有场景

```python
AD_KEYWORDS = [
    # 中文关键词
    '关注', '更新', '最新', '订阅', '公众号', '微信', 'QQ', '群', 
    '频道', '电报', 'Telegram', '推荐', '福利', '免费', 
    '网址', '网站', '发布', '必看', '说明', '广告',
    '二维码', '微信号', 'QQ号', 'TG', 'Discord',
    '夸克资源', '阿里资源', '百度资源', '更多资源', '资源群',
    '加入', '入群', '扫码', '联系', '获取',
    
    # 英文关键词
    'readme', 'read me', 'notice', 'ad', 'ads', 'adv', 
    'promo', 'promotion', 'follow', 'subscribe', 
    'update', 'new', 'latest', 'channel',
    'qrcode', 'qr code', 'wechat', 'telegram',
    
    # 常见推广站点
    'quark', 'aliyun', 'baidu', 'pan', 'yun',
    '夸克', '阿里', '百度', '网盘', '云盘',
]
```

### 规则3: 文件名模式匹配

**适用场景**: 精确匹配特定模式

```python
import re

AD_PATTERNS = [
    # 完全匹配（不区分大小写）
    r'^readme\.txt$',
    r'^说明\.txt$',
    r'^使用说明\.txt$',
    r'^必看\.txt$',
    r'^readme\.md$',
    
    # 包含匹配
    r'二维码\.(jpg|png|gif)',
    r'qrcode\.(jpg|png|gif)',
    r'微信.*\.(jpg|png|txt)',
    r'QQ.*\.(jpg|png|txt)',
    r'电报.*\.(jpg|png|txt)',
    r'群.*\.(jpg|png|txt)',
    r'更多.*资源',
    r'.*推广.*',
    r'.*广告.*',
]
```

### 规则4: 组合规则（推荐）

**策略**: 结合扩展名、文件名、文件大小的智能过滤

```python
def is_ad_file(file_info):
    """
    判断是否为广告文件
    
    Args:
        file_info: {
            'file_name': str,
            'size': int,  # 字节
            'dir': bool,
        }
    
    Returns:
        bool: True表示是广告文件，应该过滤
    """
    name = file_info['file_name'].lower()
    size = file_info['size']
    is_dir = file_info['dir']
    
    # 文件夹不过滤（除非名字明确是广告）
    if is_dir:
        return any(keyword in name for keyword in ['广告', '推广', 'ad', 'ads'])
    
    # 获取扩展名
    ext = os.path.splitext(name)[1].lower()
    
    # 1. 严格扩展名黑名单
    if ext in AD_EXTENSIONS_STRICT:
        # 小文件更可能是广告
        if size < 5 * 1024 * 1024:  # < 5MB
            return True
        # 大文件检查关键词
        if any(keyword in name for keyword in AD_KEYWORDS):
            return True
    
    # 2. 文件名包含广告关键词
    if any(keyword in name for keyword in AD_KEYWORDS):
        # 如果是小文件，直接过滤
        if size < 10 * 1024 * 1024:  # < 10MB
            return True
        # 大文件再检查扩展名
        if ext in ['.txt', '.nfo', '.url', '.html', '.htm']:
            return True
    
    # 3. 正则模式匹配
    for pattern in AD_PATTERNS:
        if re.search(pattern, name, re.IGNORECASE):
            return True
    
    # 4. 特殊情况：文件名只有1-2个字符的小文件（通常是推广）
    if len(os.path.splitext(name)[0]) <= 2 and size < 1024 * 1024:
        if ext in ['.txt', '.jpg', '.png', '.gif']:
            return True
    
    return False
```

---

## 🔧 实现策略

### 策略1: 前端预览过滤（推荐）

在获取文件列表后，先应用过滤规则，然后展示给用户：

```python
def filter_ad_files(file_list):
    """过滤广告文件"""
    clean_files = []
    ad_files = []
    
    for file in file_list:
        if is_ad_file(file):
            ad_files.append(file)
        else:
            clean_files.append(file)
    
    return {
        'clean_files': clean_files,
        'ad_files': ad_files,
        'stats': {
            'total': len(file_list),
            'clean': len(clean_files),
            'filtered': len(ad_files)
        }
    }
```

### 策略2: 用户可配置

提供不同的过滤级别：

```python
class FilterLevel:
    NONE = 0      # 不过滤
    LOOSE = 1     # 宽松（仅过滤明确的广告）
    NORMAL = 2    # 正常（推荐）
    STRICT = 3    # 严格（过滤所有可疑文件）

def apply_filter(files, level=FilterLevel.NORMAL):
    if level == FilterLevel.NONE:
        return files
    
    # 根据级别调整过滤规则
    # ...
```

### 策略3: 智能学习（可选）

记录用户手动排除的文件，学习个性化过滤规则：

```python
def learn_from_user_selection(selected_files, all_files):
    """从用户的选择中学习"""
    excluded = set(all_files) - set(selected_files)
    
    # 分析被排除文件的共同特征
    # 更新过滤规则
    pass
```

---

## 📊 实际案例分析

### 案例0: 真实案例 - 《唠｜救(2025)》电视剧 ✅

**分享链接**: https://pan.quark.cn/s/b62b96d51b91

**文件结构**:
```
唠｜救(2025)/
├── 01-4K.高码率.mkv (1008.4M) ✅ 正常剧集
├── 02-4K.高码率.mkv (1005.5M) ✅ 正常剧集
├── ...（共39个视频文件）
├── 27.mp4 (688.4M) ✅ 正常剧集
└── 热门影视更新群.jpg (165.2KB) ❌ 广告文件
```

**广告文件分析**:
- **文件名**: `热门影视更新群.jpg`
- **文件大小**: 165.2KB（典型的广告图片大小）
- **文件类型**: JPG图片
- **关键词匹配**: "热门"、"更新"、"群"
- **判定依据**: 
  - ✅ 扩展名为`.jpg`（图片类）
  - ✅ 文件名包含"群"（推广关键词）
  - ✅ 文件名包含"更新"（推广关键词）
  - ✅ 文件大小< 5MB
  - ✅ 在视频文件夹中出现图片（上下文异常）

**过滤结果**: 
- 应该被过滤：✅ **是**
- 过滤理由：**文件名关键词 + 扩展名黑名单 + 小文件**

---

### 案例1: 电影分享
```
/
├── 电影名称.mkv (5.2GB) ✅ 保留
├── 电影名称.srt (120KB) ✅ 保留（字幕）
├── 说明.txt (2KB) ❌ 过滤（文件名+扩展名+大小）
├── 二维码.png (50KB) ❌ 过滤（文件名+扩展名）
├── 更多资源.jpg (200KB) ❌ 过滤（文件名关键词）
└── readme.txt (5KB) ❌ 过滤（文件名模式）
```

### 案例2: 电视剧分享
```
/
├── 第01集/
│   ├── S01E01.mp4 (1.2GB) ✅ 保留
│   ├── 关注公众号.jpg (100KB) ❌ 过滤
│   └── 更新说明.txt (3KB) ❌ 过滤
├── 第02集/
│   ├── S01E02.mp4 (1.3GB) ✅ 保留
│   └── 广告.png (80KB) ❌ 过滤
└── 使用说明.txt (10KB) ❌ 过滤
```

### 案例3: 边界情况
```
/
├── 更新日志.txt (500KB) ⚠️ 可能误杀（官方更新日志）
├── 演员介绍.pdf (2MB) ⚠️ 可能误杀（真实内容）
├── 海报.jpg (5MB) ⚠️ 可能误杀（电影海报）
└── 制作说明.txt (50KB) ⚠️ 可能误杀（制作组信息）
```

**处理建议**：
- 对于可能误杀的情况，采用**宽松模式**或**白名单机制**
- 提供**预览界面**，让用户可以手动调整

---

## 🎨 UI 设计建议

### 文件列表展示

```
┌─────────────────────────────────────────────────┐
│ 📁 文件列表 (共57个文件，过滤3个广告)             │
├─────────────────────────────────────────────────┤
│ ☑️ 电影名称.mkv                    5.2GB         │
│ ☑️ 电影名称.srt                    120KB         │
│ ☐ 说明.txt                         2KB  🚫 广告  │
│ ☐ 二维码.png                       50KB 🚫 广告  │
│ ☐ 更多资源.jpg                     200KB 🚫 广告 │
├─────────────────────────────────────────────────┤
│ [ 全选 ] [ 反选 ] [ 显示/隐藏广告 ]              │
│ 过滤级别: ○ 不过滤 ○ 宽松 ● 正常 ○ 严格         │
└─────────────────────────────────────────────────┘
```

### 转存确认

```
┌─────────────────────────────────────────────────┐
│ 转存确认                                         │
├─────────────────────────────────────────────────┤
│ 将要转存 54 个文件到：全部文件/电影/动作片/      │
│                                                  │
│ ✅ 已自动过滤 3 个广告文件                       │
│    - 说明.txt (2KB)                              │
│    - 二维码.png (50KB)                           │
│    - 更多资源.jpg (200KB)                        │
│                                                  │
│ [ 查看被过滤的文件 ] [ 修改选择 ] [ 确认转存 ]   │
└─────────────────────────────────────────────────┘
```

---

## 🔬 高级特性（可选）

### 1. 机器学习分类

训练一个小型分类器，基于：
- 文件名长度分布
- 关键词频率
- 文件大小分布
- 文件数量比例

### 2. 社区共享规则

- 用户可以提交自己的过滤规则
- 构建规则库，定期更新
- 针对不同来源（特定分享者）定制规则

### 3. OCR识别

对于图片文件，使用OCR识别内容：
- 包含"关注"、"订阅"等字样的图片
- 二维码图片
- 联系方式图片

---

## 📝 API接口设计

### 1. 获取过滤后的文件列表

```python
POST /api/quark/list-with-filter

Request:
{
    "share_url": "https://pan.quark.cn/s/xxx",
    "pdir_fid": "0",
    "filter_level": "normal"  // none, loose, normal, strict
}

Response:
{
    "code": 0,
    "data": {
        "pwd_id": "xxx",
        "stoken": "xxx",
        "pdir_fid": "0",
        "all_files": [/* 所有文件 */],
        "clean_files": [/* 过滤后的文件 */],
        "ad_files": [/* 被过滤的广告 */],
        "stats": {
            "total": 57,
            "clean": 54,
            "filtered": 3
        }
    }
}
```

### 2. 带过滤的智能转存

```python
POST /api/quark/smart-transfer

Request:
{
    "share_url": "https://pan.quark.cn/s/xxx",
    "target_path": "/电影/动作片/",
    "filter_ads": true,  // 是否过滤广告
    "filter_level": "normal",
    "selected_fids": null,  // null表示自动选择（排除广告）
    "create_folder": true,
    "folder_name": "电影名称"
}

Response:
{
    "code": 0,
    "data": {
        "task_id": "xxx",
        "transferred_count": 54,
        "filtered_count": 3,
        "filtered_files": [
            {"name": "说明.txt", "reason": "文件名+扩展名"},
            {"name": "二维码.png", "reason": "文件名包含广告关键词"},
            {"name": "更多资源.jpg", "reason": "文件名包含广告关键词"}
        ]
    }
}
```

---

## ✅ 测试计划

### 单元测试

```python
def test_filter_rules():
    # 测试1: 明确的广告文件
    assert is_ad_file({'file_name': '说明.txt', 'size': 2048, 'dir': False}) == True
    assert is_ad_file({'file_name': '二维码.png', 'size': 51200, 'dir': False}) == True
    
    # 测试2: 正常文件
    assert is_ad_file({'file_name': '电影.mkv', 'size': 5*1024*1024*1024, 'dir': False}) == False
    assert is_ad_file({'file_name': '字幕.srt', 'size': 102400, 'dir': False}) == False
    
    # 测试3: 边界情况
    assert is_ad_file({'file_name': '更新日志.txt', 'size': 512000, 'dir': False}) == True  # 根据规则
    assert is_ad_file({'file_name': '海报.jpg', 'size': 5*1024*1024, 'dir': False}) == False  # 大文件
    
    # 测试4: 文件夹
    assert is_ad_file({'file_name': '第01集', 'size': 0, 'dir': True}) == False
    assert is_ad_file({'file_name': '广告', 'size': 0, 'dir': True}) == True
```

### 集成测试

使用真实分享链接测试过滤效果，统计：
- 准确率（正确过滤的广告 / 所有广告）
- 误杀率（被误过滤的正常文件 / 所有正常文件）

---

## 🎯 总结

广告文件过滤是一个**启发式**问题，没有100%准确的规则。建议采用：

1. ✅ **多维度组合判断**（扩展名 + 文件名 + 大小）
2. ✅ **用户可配置的过滤级别**
3. ✅ **提供预览和手动调整机制**
4. ✅ **记录用户反馈，持续优化规则**
5. ✅ **针对不同资源类型（电影/剧集/音乐）使用不同策略**

**优先级**: 宁可漏过（让用户手动排除），也不要误杀（丢失重要文件）！

