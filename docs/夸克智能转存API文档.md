# å¤¸å…‹æ™ºèƒ½è½¬å­˜APIæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

ä¸€å¥—å®Œæ•´çš„å¤¸å…‹ç½‘ç›˜æ™ºèƒ½è½¬å­˜APIï¼Œæ”¯æŒï¼š
- âœ… è‡ªåŠ¨è§£æåˆ†äº«é“¾æ¥
- âœ… è‡ªåŠ¨è¯†åˆ«å’Œè¿‡æ»¤å¹¿å‘Šæ–‡ä»¶
- âœ… æ™ºèƒ½é€‰æ‹©è½¬å­˜ç­–ç•¥ï¼ˆå…¨é€‰/åŒ…å«/æ’é™¤ï¼‰
- âœ… åŸºäºå‰§åæ˜ å°„è‡ªåŠ¨ç¡®å®šç›®æ ‡è·¯å¾„
- âœ… OpenListè‡ªåŠ¨åˆ›å»ºç›®å½•
- âœ… å¼‚æ­¥ä»»åŠ¡çŠ¶æ€è½®è¯¢

## ğŸš€ ä½¿ç”¨æµç¨‹

### å®Œæ•´äº¤äº’æµç¨‹ï¼š

```
1. å‘é€åˆ†äº«é“¾æ¥ 
   â†“
2. ç³»ç»Ÿè¿”å›æ–‡ä»¶åˆ—è¡¨ï¼ˆæ ‡è®°å¹¿å‘Šï¼‰
   â†“
3. é€‰æ‹©è¦è½¬å­˜çš„æ–‡ä»¶ï¼ˆå¯é€‰æ‹©åºå·æˆ–å…¨é€‰ï¼‰
   â†“
4. è¾“å…¥å‰§å
   â†“
5. ç³»ç»ŸæŸ¥è¯¢æ˜ å°„è¡¨ï¼Œè¿”å›ç›®æ ‡è·¯å¾„
   â†“
6. ç”¨æˆ·ç¡®è®¤
   â†“
7. ç³»ç»Ÿæ‰§è¡Œè½¬å­˜ï¼ˆOpenListåˆ›å»ºç›®å½• + å¤¸å…‹è½¬å­˜ï¼‰
   â†“
8. è½®è¯¢ä»»åŠ¡çŠ¶æ€
   â†“
9. è¿”å›è½¬å­˜ç»“æœ
```

---

## ğŸ“¡ APIæ¥å£è¯¦æƒ…

### åŸºç¡€URL
```
http://10.10.10.17:9889/api
```

---

### 1ï¸âƒ£ è§£æåˆ†äº«é“¾æ¥

**POST** `/quark/parse-share`

è§£æå¤¸å…‹åˆ†äº«é“¾æ¥ï¼Œè¿”å›æ–‡ä»¶åˆ—è¡¨ï¼ˆè‡ªåŠ¨æ ‡è®°å¹¿å‘Šæ–‡ä»¶ï¼‰

#### è¯·æ±‚ä½“ï¼š
```json
{
  "share_url": "https://pan.quark.cn/s/xxx#/list/share/xxx"
}
```

#### å“åº”ï¼š
```json
{
  "success": true,
  "session_id": "uuid-xxx",
  "files": [
    {
      "index": 1,
      "fid": "xxx",
      "name": "01.mp4",
      "size": 636780000,
      "is_ad": false,
      "share_fid_token": "xxx"
    },
    {
      "index": 17,
      "fid": "yyy",
      "name": "çƒ­é—¨å½±è§†æ›´æ–°ç¾¤.jpg",
      "size": 150000,
      "is_ad": true,
      "share_fid_token": "yyy"
    }
  ],
  "stats": {
    "total": 18,
    "ad_count": 1,
    "clean_count": 17
  }
}
```

#### è¯´æ˜ï¼š
- `session_id`: ä¼šè¯IDï¼Œåç»­æ­¥éª¤éœ€è¦ä½¿ç”¨
- `files[].is_ad`: æ˜¯å¦ä¸ºå¹¿å‘Šæ–‡ä»¶ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰
- `stats`: ç»Ÿè®¡ä¿¡æ¯

---

### 2ï¸âƒ£ é€‰æ‹©æ–‡ä»¶

**POST** `/quark/select-files`

é€‰æ‹©è¦è½¬å­˜çš„æ–‡ä»¶

#### è¯·æ±‚ä½“ï¼š
```json
{
  "session_id": "uuid-xxx",
  "selection": "all"
}
```

#### selection æ ¼å¼ï¼š
- `"all"` æˆ– `"a"` æˆ– `"å…¨éƒ¨"`: é€‰æ‹©æ‰€æœ‰å¹²å‡€æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ’é™¤å¹¿å‘Šï¼‰
- `"1,3,5"`: é€‰æ‹©ç¬¬1ã€3ã€5ä¸ªæ–‡ä»¶
- `"1-10"`: é€‰æ‹©ç¬¬1åˆ°10ä¸ªæ–‡ä»¶
- `"1,3-5,7"`: æ··åˆæ ¼å¼

#### å“åº”ï¼š
```json
{
  "success": true,
  "selected_count": 17,
  "skipped_ads": ["çƒ­é—¨å½±è§†æ›´æ–°ç¾¤.jpg"],
  "message": "å·²é€‰æ‹© 17 ä¸ªæ–‡ä»¶ï¼Œè¯·è¾“å…¥å‰§å"
}
```

#### è¯´æ˜ï¼š
- è‡ªåŠ¨è·³è¿‡å¹¿å‘Šæ–‡ä»¶
- è¿”å›å®é™…é€‰æ‹©çš„æ–‡ä»¶æ•°é‡

---

### 3ï¸âƒ£ æŸ¥è¯¢ç›®æ ‡è·¯å¾„

**POST** `/quark/get-target-path`

æ ¹æ®å‰§åæŸ¥è¯¢ç›®æ ‡è·¯å¾„ï¼ˆæŸ¥è¯¢ `custom_name_mapping` è¡¨ï¼‰

#### è¯·æ±‚ä½“ï¼š
```json
{
  "session_id": "uuid-xxx",
  "media_name": "éª„é˜³ä¼¼æˆ‘"
}
```

#### æˆåŠŸå“åº”ï¼š
```json
{
  "success": true,
  "media_name": "éª„é˜³ä¼¼æˆ‘",
  "quark_name": "J æ•™å…»æ˜¯æˆ‘",
  "category": "å‰§é›†/å›½äº§å‰§é›†",
  "display_path": "/å‰§é›†/å›½äº§å‰§é›†/J æ•™å…»æ˜¯æˆ‘",
  "full_path": "/kuake/A-é—²é±¼å½±è§†/å‰§é›†/å›½äº§å‰§é›†/J æ•™å…»æ˜¯æˆ‘",
  "message": "å°†ä¿å­˜åˆ°ï¼š/å‰§é›†/å›½äº§å‰§é›†/J æ•™å…»æ˜¯æˆ‘\n\nç¡®è®¤è¯·å›å¤ï¼šç¡®è®¤"
}
```

#### å¤±è´¥å“åº”ï¼ˆæœªæ‰¾åˆ°æ˜ å°„ï¼‰ï¼š
```json
{
  "success": false,
  "error": "æœªæ‰¾åˆ°å‰§åæ˜ å°„",
  "message": "æœªæ‰¾åˆ°'æŸå‰§'çš„ä¿å­˜ä½ç½®ï¼Œè¯·å…ˆé…ç½®æ˜ å°„å…³ç³»"
}
```

#### è¯´æ˜ï¼š
- ä» `custom_name_mapping` è¡¨æŸ¥è¯¢
- `display_path`: æ˜¾ç¤ºç»™ç”¨æˆ·çœ‹çš„è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
- `full_path`: OpenListå®Œæ•´è·¯å¾„ï¼ˆåŒ…å«æŒ‚è½½ç‚¹ï¼‰

---

### 4ï¸âƒ£ æ‰§è¡Œè½¬å­˜

**POST** `/quark/execute-transfer`

ç¡®è®¤åæ‰§è¡Œè½¬å­˜

#### è¯·æ±‚ä½“ï¼š
```json
{
  "session_id": "uuid-xxx"
}
```

#### å“åº”ï¼š
```json
{
  "success": true,
  "task_id": "xxx",
  "mode": "æ’é™¤æ¨¡å¼",
  "message": "æ­£åœ¨è½¬å­˜ï¼Œè¯·ç¨å€™..."
}
```

#### æ™ºèƒ½ç­–ç•¥è¯´æ˜ï¼š
- **å…¨é€‰æ¨¡å¼** (100%): `pdir_save_all: true`
- **æ’é™¤æ¨¡å¼** (>50%): `pdir_save_all: true` + `exclude_fids: [...]`
- **åŒ…å«æ¨¡å¼** (â‰¤50%): `pdir_save_all: false` + `fid_list: [...]`

#### åç«¯å¤„ç†æµç¨‹ï¼š
1. é€šè¿‡ OpenList API è·å–/åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
2. æ™ºèƒ½é€‰æ‹©è½¬å­˜ç­–ç•¥
3. è°ƒç”¨å¤¸å…‹è½¬å­˜API
4. è¿”å›ä»»åŠ¡ID

---

### 5ï¸âƒ£ æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

**GET** `/quark/task-status/{task_id}`

è½®è¯¢ä»»åŠ¡çŠ¶æ€

#### å“åº”ï¼ˆè¿›è¡Œä¸­ï¼‰ï¼š
```json
{
  "success": true,
  "status": "processing",
  "message": "è½¬å­˜ä¸­ï¼Œè¯·ç»§ç»­ç­‰å¾…..."
}
```

#### å“åº”ï¼ˆå·²å®Œæˆï¼‰ï¼š
```json
{
  "success": true,
  "status": "completed",
  "transferred": 17,
  "ad_filtered": 1,
  "display_path": "/å‰§é›†/å›½äº§å‰§é›†/J æ•™å…»æ˜¯æˆ‘",
  "mode": "æ’é™¤æ¨¡å¼",
  "message": "âœ… è½¬å­˜å®Œæˆï¼\nâ€¢ å·²ä¿å­˜ï¼š17ä¸ªæ–‡ä»¶\nâ€¢ å·²è¿‡æ»¤ï¼š1ä¸ªå¹¿å‘Š\nâ€¢ ä¿å­˜ä½ç½®ï¼š/å‰§é›†/å›½äº§å‰§é›†/J æ•™å…»æ˜¯æˆ‘"
}
```

---

### 6ï¸âƒ£ è·å–å‰§ååˆ—è¡¨ï¼ˆè¾…åŠ©ï¼‰

**GET** `/quark/list-media-names`

è·å–æ‰€æœ‰å¯ç”¨çš„å‰§ååˆ—è¡¨

#### å“åº”ï¼š
```json
{
  "success": true,
  "media_names": ["éª„é˜³ä¼¼æˆ‘", "æŸå‰§", "æŸå‰§2"],
  "total": 3
}
```

---

## ğŸ’¾ æ•°æ®åº“è¡¨ç»“æ„

### custom_name_mapping è¡¨

```sql
CREATE TABLE custom_name_mapping (
    id INT AUTO_INCREMENT PRIMARY KEY,
    original_name VARCHAR(191) NOT NULL,    -- å‰§åï¼ˆç”¨æˆ·è¾“å…¥ï¼‰
    quark_name VARCHAR(500),                -- å¤¸å…‹ç½‘ç›˜æ˜¾ç¤ºåç§°
    category VARCHAR(100),                  -- äºŒçº§åˆ†ç±»ï¼šå‰§é›†/å›½äº§å‰§é›†
    enabled TINYINT(1),                     -- æ˜¯å¦å¯ç”¨
    sync_to_quark TINYINT(1) DEFAULT 1,     -- æ˜¯å¦åŒæ­¥åˆ°å¤¸å…‹
    ...
);
```

### è·¯å¾„æ‹¼æ¥è§„åˆ™ï¼š

```python
# ç”¨æˆ·è¾“å…¥
media_name = "éª„é˜³ä¼¼æˆ‘"

# æŸ¥è¯¢è¡¨å¾—åˆ°
quark_name = "J æ•™å…»æ˜¯æˆ‘"
category = "å‰§é›†/å›½äº§å‰§é›†"

# æ‹¼æ¥è·¯å¾„
display_path = f"/{category}/{quark_name}"
             = "/å‰§é›†/å›½äº§å‰§é›†/J æ•™å…»æ˜¯æˆ‘"

full_path = f"/kuake/A-é—²é±¼å½±è§†/{category}/{quark_name}"
          = "/kuake/A-é—²é±¼å½±è§†/å‰§é›†/å›½äº§å‰§é›†/J æ•™å…»æ˜¯æˆ‘"
```

---

## ğŸ§ª æµ‹è¯•

### ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼š

```bash
cd /Users/lizhiqiang/coding-my/file-link-monitor/backend
python3 tests/test_quark_api.py
```

### æˆ–ä½¿ç”¨ curlï¼š

#### 1. è§£æé“¾æ¥
```bash
curl -X POST http://10.10.10.17:9889/api/quark/parse-share \
  -H "Content-Type: application/json" \
  -d '{"share_url": "https://pan.quark.cn/s/xxx"}'
```

#### 2. é€‰æ‹©æ–‡ä»¶
```bash
curl -X POST http://10.10.10.17:9889/api/quark/select-files \
  -H "Content-Type: application/json" \
  -d '{"session_id": "xxx", "selection": "all"}'
```

#### 3. æŸ¥è¯¢è·¯å¾„
```bash
curl -X POST http://10.10.10.17:9889/api/quark/get-target-path \
  -H "Content-Type: application/json" \
  -d '{"session_id": "xxx", "media_name": "éª„é˜³ä¼¼æˆ‘"}'
```

#### 4. æ‰§è¡Œè½¬å­˜
```bash
curl -X POST http://10.10.10.17:9889/api/quark/execute-transfer \
  -H "Content-Type: application/json" \
  -d '{"session_id": "xxx"}'
```

#### 5. æŸ¥è¯¢çŠ¶æ€
```bash
curl http://10.10.10.17:9889/api/quark/task-status/xxx
```

---

## âš™ï¸ é…ç½®è¦æ±‚

### 1. æ•°æ®åº“é…ç½®
- MySQL æ•°æ®åº“ï¼š`file_link_monitor_v2`
- è¡¨ï¼š`custom_name_mapping`ã€`pan_cookies`

### 2. OpenListæœåŠ¡
- URL: `http://10.10.10.17:5255`
- Token: `openlist-xxx...`
- å¤¸å…‹æŒ‚è½½ç‚¹ï¼š`/kuake`

### 3. å¤¸å…‹Cookie
- å­˜å‚¨åœ¨ `pan_cookies` è¡¨
- `pan_type = 'quark'`
- `is_active = True`

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¼šè¯ç®¡ç†
- ä½¿ç”¨å†…å­˜å­—å…¸å­˜å‚¨ä¼šè¯ï¼ˆ`sessions`ï¼‰
- ä¼šè¯æœ‰æ•ˆæœŸï¼š1å°æ—¶
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯

### å¹¿å‘Šæ–‡ä»¶è¯†åˆ«è§„åˆ™
- æ–‡ä»¶æ‰©å±•åï¼š`.jpg`, `.png`, `.txt`, `.nfo`ç­‰
- å…³é”®è¯ï¼š`ç¾¤`, `æ›´æ–°`, `å…³æ³¨`, `å¾®ä¿¡`, `qq`ç­‰
- æ–‡ä»¶å¤§å°ï¼šå›¾ç‰‡<5MBï¼Œæ–‡æœ¬<500KB

### æ™ºèƒ½è½¬å­˜ç­–ç•¥
- é€‰æ‹©æ¯”ä¾‹ = 100%ï¼šå…¨é€‰æ¨¡å¼
- é€‰æ‹©æ¯”ä¾‹ > 50%ï¼šæ’é™¤æ¨¡å¼ï¼ˆæ’é™¤æœªé€‰æ‹©çš„ï¼‰
- é€‰æ‹©æ¯”ä¾‹ â‰¤ 50%ï¼šåŒ…å«æ¨¡å¼ï¼ˆåªåŒ…å«é€‰æ‹©çš„ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥ï¼šä¼ä¸šå¾®ä¿¡å¯¹æ¥

å®ŒæˆAPIåï¼Œå¯ä»¥å¯¹æ¥ä¼ä¸šå¾®ä¿¡å®ç°ï¼š
1. ç”¨æˆ·å‘é€é“¾æ¥åˆ°ä¼ä¸šå¾®ä¿¡
2. ä¼ä¸šå¾®ä¿¡è°ƒç”¨APIè§£æ
3. æ¨é€æ–‡ä»¶åˆ—è¡¨å¡ç‰‡
4. ç”¨æˆ·å›å¤é€‰æ‹©
5. æ¨é€è½¬å­˜ç»“æœ

è¯¦è§ï¼šã€Šä¼ä¸šå¾®ä¿¡å¯¹æ¥æ–¹æ¡ˆã€‹ï¼ˆå¾…ç¼–å†™ï¼‰

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f /path/to/backend.log
```

APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆï¼š
```
http://10.10.10.17:9889/docs
```

