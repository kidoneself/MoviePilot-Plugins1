# 企业微信夸克转存使用指南

## ✅ 已完成集成

夸克智能转存功能已完全集成到企业微信！

---

## 🎯 使用流程

### 完整交互示例：

```
1️⃣ 你发送夸克分享链接
   "https://pan.quark.cn/s/xxx"
   
   ↓

2️⃣ 系统自动解析并回复
   "📦 文件列表（共18个）
   ✅ 干净文件：17个
   🚫 广告文件：1个
   
   1. 01.mp4 (636.8MB)
   2. 02.mp4 (654.9MB)
   ...
   
   请回复：
   • all - 全选干净文件
   • 1,3,5 - 选择指定序号
   • 1-10 - 选择范围"
   
   ↓

3️⃣ 你回复
   "all"
   
   ↓

4️⃣ 系统回复
   "✅ 已选择 17 个文件
   
   🎬 请输入剧名（如：老舅）"
   
   ↓

5️⃣ 你回复
   "老舅"
   
   ↓

6️⃣ 系统回复
   "✅ 找到保存位置
   
   📂 /剧集/国产剧集/姥姥姥姥
   
   ━━━━━━━━━━━━━━━
   📋 转存信息：
   • 剧名：老舅
   • 文件：17个
   • 位置：/剧集/国产剧集/姥姥姥姥
   
   ━━━━━━━━━━━━━━━
   确认转存请回复：确认
   取消请回复：取消"
   
   ↓

7️⃣ 你回复
   "确认"
   
   ↓

8️⃣ 系统开始转存
   "⏳ 正在转存，请稍候..."
   
   ↓

9️⃣ 转存完成
   "✅ 转存完成！
   
   • 已保存：17个文件
   • 已过滤：1个广告
   • 保存位置：/剧集/国产剧集/姥姥姥姥
   • 转存策略：排除模式"
```

---

## 📝 支持的命令

### 夸克转存
- 直接发送夸克分享链接（包含 `pan.quark.cn/s/`）
- 系统会自动识别并进入转存流程

### 文件选择格式
- `all` 或 `a` 或 `全部` - 全选所有干净文件
- `1,3,5` - 选择第1、3、5个文件
- `1-10` - 选择第1到10个文件
- `1,3-5,7` - 混合格式

### 其他命令
- `?` 或 `帮助` - 显示帮助信息
- `未完结` - 查看未完结剧集列表
- `检查更新` - 立即检查TMDB更新
- 直接发送剧名 - 搜索剧集

---

## 🔧 技术实现

### 文件结构
```
backend/
├── api/
│   ├── quark_smart_transfer.py  # 后端API（5个接口）
│   └── wechat.py                # 企业微信回调
├── handlers/
│   ├── wechat_handler.py        # 主消息处理器
│   └── quark_transfer_handler.py # 夸克转存处理器（新增）
└── services/
    └── wechat_service.py        # 企业微信服务
```

### 工作流程
1. 用户发送消息 → `wechat.py` 接收回调
2. 解密并解析消息 → 交给 `wechat_handler.py`
3. 检测到夸克链接 → 交给 `quark_transfer_handler.py`
4. 处理器调用本地API → `quark_smart_transfer.py`
5. API完成转存 → 返回结果
6. 处理器推送消息 → 用户收到通知

### 状态机设计
```python
States:
- waiting_file_selection   # 等待选择文件
- waiting_media_name       # 等待输入剧名
- waiting_confirm          # 等待确认转存
```

---

## ⚙️ 配置说明

### 企业微信配置（config.yaml）
```yaml
wechat:
  enabled: true
  corp_id: "wwdf6106d7f613ab4d"
  agent_id: 1000004
  secret: "81qGwjsand45s-UluYPA16hroksblUVZ6d5w8eVXEkw"
  token: "zFYzEyQDonVV"
  encoding_aes_key: "SsZwYFgwmDOfAKIqqQ6GEPjU1ohLVLK2rNcISxYzbOn"
  callback_url: "https://link.frp.naspt.vip/api/wechat/callback"
```

### API地址（quark_transfer_handler.py）
```python
API_BASE = "http://127.0.0.1:9889/api"  # 本地API地址
```

---

## 🧪 测试

### 1. 测试后端API
```bash
cd /Users/lizhiqiang/coding-my/file-link-monitor/backend
python3 tests/test_quark_api.py
```

### 2. 测试企业微信
1. 启动后端服务
2. 在企业微信中发送测试链接
3. 观察日志输出

### 3. 查看日志
```bash
# 查看企业微信消息日志
grep "收到消息" backend.log

# 查看夸克转存日志
grep "夸克转存" backend.log
```

---

## 🎨 功能特性

### ✅ 已实现
- [x] 自动解析夸克分享链接
- [x] 自动识别和过滤广告文件
- [x] 智能选择转存策略（全选/包含/排除）
- [x] 基于剧名映射自动确定目标路径
- [x] OpenList自动创建目录
- [x] 异步任务状态轮询
- [x] 完整的企业微信交互流程
- [x] 会话状态管理（支持多用户）
- [x] 友好的错误提示

### 📋 待优化
- [ ] 支持图片识别（识别分享二维码截图）
- [ ] 支持批量转存（一次发送多个链接）
- [ ] 转存历史记录查询
- [ ] 进度实时推送（WebSocket）
- [ ] 支持选择目标目录（不仅限于映射表）

---

## 🐛 故障排查

### 问题1: 发送链接没反应
**检查：**
1. 后端服务是否运行（9889端口）
2. 企业微信回调是否配置正确
3. 查看日志是否有错误

**解决：**
```bash
# 检查服务
curl http://127.0.0.1:9889/docs

# 查看日志
tail -f backend.log | grep -E "企业微信|夸克"
```

### 问题2: 解析链接失败
**原因：**
- Cookie过期
- 网络问题
- 链接格式不正确

**解决：**
1. 更新数据库中的夸克Cookie
2. 检查网络连接
3. 确认链接格式正确

### 问题3: 找不到剧名映射
**原因：**
- `custom_name_mapping` 表中没有对应记录

**解决：**
```sql
-- 添加映射记录
INSERT INTO custom_name_mapping 
(original_name, quark_name, category, enabled, sync_to_quark)
VALUES 
('老舅', 'J 教养是我', '剧集/国产剧集', 1, 1);
```

---

## 📞 联系与支持

如有问题：
1. 查看日志文件
2. 访问API文档：http://127.0.0.1:9889/docs
3. 检查企业微信回调配置

---

## 🎉 完成！

现在你可以在企业微信中直接发送夸克分享链接，系统会自动帮你完成转存！

**享受自动化的便利吧！** 🚀

