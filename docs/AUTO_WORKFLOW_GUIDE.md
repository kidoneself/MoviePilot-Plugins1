# 🤖 闲鱼自动化工作流使用指南

## 功能概述

自动化工作流页面可以一键完成从创建商品到设置自动发货的全流程，无需人工干预，极大提高效率。

## 工作流步骤

### 完整流程（5个步骤）

1. **准备商品图片** - 上传或使用默认图片
2. **创建闲鱼商品** - 自动创建并上架到店铺
3. **创建卡种** - 在闲鱼后台创建虚拟商品卡种
4. **添加卡密** - 批量添加卡密数据
5. **设置自动发货** - 配置自动发货规则

## 使用方法

### 1. 访问页面

- **直接访问**：`http://localhost:8080/xianyu/auto-workflow`
- **侧边栏入口**：点击左侧菜单 "🤖 自动化工作流"

### 2. 填写配置

#### 商品信息
- **商品标题**：如 "网盘会员账号"
- **商品描述**：详细介绍商品内容
- **价格**：单位为元，如 0.1 元
- **库存**：建议设置较大值，如 100

#### 卡密信息
- **卡种名称**：如 "网盘会员卡"（必须唯一）
- **卡密数据**：按格式输入，每行一组
  ```
  账号1----密码1----2025-12-31
  账号2----密码2----2025-12-31
  账号3----密码3----2025-12-31
  ```
- **重复次数**：每组卡密可售卖的次数（1-10次）

### 3. 执行流程

1. 填写完所有必填项后，"🚀 开始自动化流程"按钮会变为可点击
2. 点击按钮，确认执行
3. 右侧日志区域会实时显示执行进度
4. 如果需要扫码登录，会显示二维码，请使用闲鱼App扫码

### 4. 查看结果

执行完成后，页面底部会显示执行结果：
- ✅ **成功**：显示商品ID、卡种名称、总耗时
- ❌ **失败**：显示错误信息和失败步骤

## 日志说明

### 日志类型

| 颜色/图标 | 状态 | 说明 |
|---------|------|------|
| 🔵 蓝色 | 执行中 | 正在执行该步骤 |
| ✅ 绿色 | 成功 | 步骤执行成功 |
| ❌ 红色 | 失败 | 步骤执行失败 |
| ⚠️ 黄色 | 警告 | 需要用户操作（如扫码） |
| ℹ️ 灰色 | 信息 | 一般性提示信息 |

### 示例日志

```
15:30:01 步骤 1/5 - 准备上传商品图片... [执行中]
15:30:02 步骤 1/5 - 图片准备完成 [成功]
15:30:02 步骤 2/5 - 正在创建闲鱼商品... [执行中]
15:30:05 步骤 2/5 - 商品创建成功，ID: 123456 [成功]
15:30:05 步骤 3/5 - 正在创建卡种... [执行中]
15:30:06 步骤 3/5 - 任务已创建，ID: abc123 [信息]
15:30:08 等待扫码登录 [警告] - 显示二维码
15:30:45 步骤 3/5 - 卡种创建成功 [成功]
...
```

## 扫码登录

### 为什么需要扫码？

闲鱼的卡密管理功能需要通过Selenium模拟浏览器操作，首次使用或会话过期时需要扫码登录。

### 扫码流程

1. 当日志显示二维码时，使用**闲鱼App**扫码
2. 在App中确认登录
3. 登录成功后，流程会自动继续
4. **会话保持**：登录一次后，短时间内无需重复登录

### 注意事项

- ⚠️ 只能使用闲鱼App扫码，不能使用微信/支付宝
- ⚠️ 二维码有效期约2分钟，超时需重新执行
- ⚠️ 扫码后请在App中点击"确认登录"

## 配置要求

执行前请确保以下配置已设置（在系统设置页面）：

### 必需配置

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `goofish.app_key` | 闲鱼API Key | `xxx` |
| `goofish.app_secret` | 闲鱼API Secret | `xxx` |
| `username1` | 闲鱼会员名1 | `tb123456` |

### 可选配置

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| `username2` | 闲鱼会员名2（双店铺） | - |
| `product.price` | 默认商品价格（元） | 0.1 |
| `product.stock` | 默认库存 | 100 |
| `product.express.fee` | 默认运费（元） | 0 |
| `product.stuff.status` | 商品成色 | 100（全新） |

## 常见问题

### Q1: 执行失败，如何排查？

A: 查看右侧日志，找到失败的具体步骤：
- **步骤1-2失败**：检查闲鱼API配置
- **步骤3-5失败**：检查扫码是否成功，浏览器是否正常

### Q2: 二维码显示不出来？

A: 可能原因：
1. 后端Selenium服务未启动
2. 图片生成失败
3. 解决方法：刷新页面重试，或查看后端日志

### Q3: 卡种名称重复怎么办？

A: 卡种名称必须唯一，如果已存在同名卡种：
- 方案1：使用不同的卡种名称
- 方案2：直接跳过步骤3（创建卡种），手动修改代码只执行步骤4（添加卡密）

### Q4: 能否只执行部分步骤？

A: 当前版本执行完整流程，如需单独操作：
- 创建商品：使用 "创建商品页面"
- 卡密管理：使用 "卡密管理页面"

### Q5: 执行很慢，如何优化？

A: 正常情况下全流程需要1-3分钟：
- 扫码登录：30-60秒
- 创建卡种：20-40秒
- 添加卡密：视卡密数量而定
- 设置自动发货：20-30秒

### Q6: 支持批量执行吗？

A: 当前不支持批量，如需批量创建：
1. 准备好商品列表
2. 逐个执行自动化流程
3. 或编写脚本调用后端API

## 技术细节

### 后端API

流程中调用的API：

```bash
# 1. 上传图片并创建商品
POST /api/xianyu/product/upload-images

# 2. 创建卡种（异步任务）
POST /api/xianyu/kami/create-kind

# 3. 添加卡密（异步任务）
POST /api/xianyu/kami/add-cards

# 4. 设置自动发货（异步任务）
POST /api/xianyu/kami/setup-shipping

# 5. 查询任务状态
GET /api/xianyu/kami/task/{task_id}
```

### 异步任务轮询

卡密相关操作（步骤3-5）使用异步任务模式：
- 后端创建任务，返回 `task_id`
- 前端每2秒轮询任务状态
- 任务完成或失败时停止轮询

### 会话管理

Selenium浏览器会话：
- 首次使用需要扫码登录
- 登录后会话保持在后端
- 关闭浏览器：可访问 `/api/xianyu/kami/close-browser`

## 最佳实践

### 1. 准备工作

- ✅ 提前配置好所有必需参数
- ✅ 准备好卡密数据（Excel导出或批量生成）
- ✅ 确保网络稳定

### 2. 卡密格式

推荐使用标准格式：
```
账号----密码----到期日期
```

支持的分隔符：
- `----` （4个短横线，推荐）
- `\t` （制表符）
- `,` （逗号，需确保数据中无逗号）

### 3. 批量操作

如需创建多个商品：

**方案1**：循环执行
```
商品A → 执行流程 → 完成
商品B → 执行流程 → 完成
商品C → 执行流程 → 完成
```

**方案2**：复用卡种
```
第一次：完整流程（包含创建卡种）
第二次起：只添加卡密到已有卡种
```

### 4. 异常处理

遇到问题时：
1. 查看日志定位失败步骤
2. 检查配置是否正确
3. 重试（有些问题是临时性的）
4. 查看后端日志获取详细错误

## 更新日志

### 2024-12-25 v1.0
- ✅ 首次发布
- ✅ 支持5步自动化流程
- ✅ 实时日志显示
- ✅ 二维码扫码登录
- ✅ 任务状态轮询
- ✅ 执行结果展示

## 反馈与建议

如有问题或建议，欢迎反馈！

